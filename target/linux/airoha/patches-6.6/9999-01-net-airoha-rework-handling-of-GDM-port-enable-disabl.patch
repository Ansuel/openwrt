From d158ebb5d126e1b1099f44cecd813147877e9c46 Mon Sep 17 00:00:00 2001
From: Christian Marangi <ansuelsmth@gmail.com>
Date: Fri, 17 Jan 2025 10:06:05 +0100
Subject: [PATCH 1/9] net: airoha: rework handling of GDM port enable/disable

In preparation for phylink support, rework handling of GDM port
enable/disable and change only the relevant port.

This is done to stop other interface ((like the internal switch
interface) to affect other GDM port by disabling them.

A new logic is implemented where each GDM port have a type.

Signed-off-by: Christian Marangi <ansuelsmth@gmail.com>
---
 drivers/net/ethernet/mediatek/airoha_eth.c | 51 ++++++++++------------
 drivers/net/ethernet/mediatek/airoha_eth.h |  5 ++-
 2 files changed, 27 insertions(+), 29 deletions(-)

--- a/drivers/net/ethernet/mediatek/airoha_eth.c
+++ b/drivers/net/ethernet/mediatek/airoha_eth.c
@@ -63,6 +63,22 @@ static void airoha_qdma_irq_disable(stru
 	airoha_qdma_set_irqmask(qdma, index, mask, 0);
 }
 
+static enum airoha_gdm_port_type airoha_get_gdm_port_type(struct airoha_gdm_port *port)
+{
+	/* TODO handle USB port on GDM4 and PCIE1 port on GDM3 */
+	switch (port->id) {
+	case 4:
+		return XSI_ETH_PORT; /* ETH port */
+	case 3:
+		return XSI_PCIE0_PORT;
+	case 2:
+		return XSI_AE_PORT; /* PON port */
+	case 1:
+	default:
+		return INTERNAL_SWITCH_PORT;
+	}
+}
+
 static bool airhoa_is_lan_gdm_port(struct airoha_gdm_port *port)
 {
 	/* GDM1 port on EN7581 SoC is connected to the lan dsa switch.
@@ -2583,6 +2599,7 @@ static int airoha_alloc_gdm_port(struct
 	port->qdma = qdma;
 	port->dev = dev;
 	port->id = id;
+	port->type = airoha_get_gdm_port_type(port);
 	eth->ports[p] = port;
 
 	err = airoha_metadata_dst_alloc(port);
--- a/drivers/net/ethernet/mediatek/airoha_eth.h
+++ b/drivers/net/ethernet/mediatek/airoha_eth.h
@@ -75,6 +75,15 @@ enum {
 	QDMA_INT_REG_MAX
 };
 
+enum airoha_gdm_port_type {
+	XSI_PCIE0_PORT,
+	XSI_PCIE1_PORT,
+	XSI_USB_PORT,
+	XSI_AE_PORT,
+	XSI_ETH_PORT,
+	INTERNAL_SWITCH_PORT,
+};
+
 enum {
 	HSGMII_LAN_PCIE0_SRCPORT = 0x16,
 	HSGMII_LAN_PCIE1_SRCPORT,
@@ -455,6 +464,8 @@ struct airoha_qdma {
 struct airoha_gdm_port {
 	struct airoha_qdma *qdma;
 	struct net_device *dev;
+
+	enum airoha_gdm_port_type type;
 	int id;
 
 	struct airoha_hw_stats stats;
