From 6fbf17729cfff37ed0afbebeff95bee5ee9818bf Mon Sep 17 00:00:00 2001
Message-ID: <6fbf17729cfff37ed0afbebeff95bee5ee9818bf.1738080839.git.lorenzo@kernel.org>
From: Lorenzo Bianconi <lorenzo@kernel.org>
Date: Tue, 28 Jan 2025 10:22:09 +0100
Subject: [PATCH net-next] net: airoha: Integrate QoS support for traffic
 accelerator

Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
---
 drivers/net/ethernet/mediatek/airoha_ppe.c | 19 +++++++++++++++----
 1 file changed, 15 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/mediatek/airoha_ppe.c b/drivers/net/ethernet/mediatek/airoha_ppe.c
index dac29932ccfe..a826e9e16a7e 100644
--- a/drivers/net/ethernet/mediatek/airoha_ppe.c
+++ b/drivers/net/ethernet/mediatek/airoha_ppe.c
@@ -473,11 +473,12 @@ static int airoha_get_dsa_port(struct net_device **dev)
 
 static int airoha_ppe_foe_entry_prepare(struct airoha_foe_entry *hwe,
 					struct net_device *dev, int type,
-					int l4proto, u8 *src_mac, u8 *dest_mac)
+					int l4proto, u8 *src_mac, u8 *dest_mac,
+					u32 mark)
 {
 	int dsa_port = airoha_get_dsa_port(&dev);
+	u32 channel, data, ports_pad, val;
 	struct airoha_foe_mac_info *l2;
-	u32 data, ports_pad, val;
 
 	memset(hwe, 0, sizeof(*hwe));
 
@@ -512,7 +513,12 @@ static int airoha_ppe_foe_entry_prepare(struct airoha_foe_entry *hwe,
 	if (type == MTK_PPE_PKT_TYPE_IPV6_ROUTE_3T)
 		hwe->ipv6.ports = ports_pad;
 
-	data = FIELD_PREP(AIROHA_FOE_SHAPER_ID, 0x7f);
+	channel = mark / AIROHA_NUM_QOS_QUEUES;
+	data = FIELD_PREP(AIROHA_FOE_CHANNEL,
+			  channel % AIROHA_NUM_QOS_CHANNELS) |
+	       FIELD_PREP(AIROHA_FOE_QID, mark % AIROHA_NUM_QOS_QUEUES) |
+	       FIELD_PREP(AIROHA_FOE_SHAPER_ID, 0x7f);
+
 	if (type >= MTK_PPE_PKT_TYPE_IPV4_DSLITE) {
 		hwe->ipv6.data = data;
 		hwe->ipv6.ib2 = val;
@@ -813,6 +819,7 @@ static int airoha_ppe_flow_offload_replace(struct airoha_gdm_port *port,
 	int err, i, offload_type;
 	u16 addr_type = 0;
 	u8 l4proto = 0;
+	u32 mark = 0;
 
 	if (rhashtable_lookup(&eth->flow_table, &f->cookie,
 			      airoha_flow_table_params))
@@ -885,6 +892,9 @@ static int airoha_ppe_flow_offload_replace(struct airoha_gdm_port *port,
 			data.pppoe.sid = act->pppoe.sid;
 			data.pppoe.num++;
 			break;
+		case FLOW_ACTION_MARK:
+			mark = act->mark;
+			break;
 		default:
 			return -EOPNOTSUPP;
 		}
@@ -895,7 +905,8 @@ static int airoha_ppe_flow_offload_replace(struct airoha_gdm_port *port,
 		return -EINVAL;
 
 	err = airoha_ppe_foe_entry_prepare(&hwe, odev, offload_type, l4proto,
-					   data.eth.h_source, data.eth.h_dest);
+					   data.eth.h_source, data.eth.h_dest,
+					   mark);
 	if (err)
 		return err;
 
-- 
2.48.1

