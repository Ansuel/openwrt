#!/bin/bash -xe

[ -f ./Makefile ] && make clean || true
[ -d ./tmp ] && rm -rf ./tmp
[ -d ./bin ] && rm -rf ./bin

# Build u-boot
./compile_u-boot

# Install luci feed
./scripts/feeds update luci
./scripts/feeds install luci

# Build NAND FW
cp configs/config-turris-nand .config
[ -n "$BUILD_ALL" ] && echo "CONFIG_ALL=y" >> .config
make defconfig
export TARGET_BOARD=turris
./set_opkg_url
make clean
if [ -z "$BUILD_ALL" ]; then
	make "$@" 
else
	make make -j1 V=99 IGNORE_ERRORS=m
fi

# Clean
[ -d ./bin-nand ] && rm -rf ./bin-nand
mv ./bin ./bin-nand
make clean
[ -d ./tmp ] && rm -rf ./tmp

# Build NOR FW
cp configs/config-turris-nor .config
make defconfig
make clean
make "$@"
[ -d ./bin/mpc85xx/packages ] && rm -rf ./bin/mpc85xx/packages
[ -d ./bin-nor ] && rm -rf ./bin-nor
mv ./bin ./bin-nor


