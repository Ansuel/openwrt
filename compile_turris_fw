#!/bin/bash -xe

# Cleaning 
[ -d ./tmp ] && rm -rf ./tmp
[ -d ./bin ] && rm -rf ./bin

# Build u-boot
./compile_u-boot

# Install luci feed
./scripts/feeds update lucics
./scripts/feeds install luci
./scripts/feeds install luci-i18n-czech

# Install routing feed and bird package
./scripts/feeds update routing
./scripts/feeds install bird4 birdc4 bird6 birdc6

# Build NAND FW
cp configs/config-turris-nand .config
[ -n "$BUILD_ALL" ] && echo "CONFIG_ALL=y" >> .config
[ -n "$USE_CCACHE" ] && echo "CONFIG_CCACHE=y" >> .config
make defconfig
export TARGET_BOARD=turris
if [ -d .git ] ; then
	git log -n1 --format='%H' >files/etc/git-version
fi
make clean
make "$@"
# Preserve the uncompressed image too
mv build_dir/target-powerpc_*/root-mpc85xx bin/mpc85xx/root
cd bin/mpc85xx/root
rm var
find -type l ! -exec test -r {} \; -delete
cd ../../..

# Clean
[ -d ./bin-nand ] && rm -rf ./bin-nand
mv ./bin ./bin-nand
[ -d ./tmp ] && rm -rf ./tmp

# Build NOR FW
cp configs/config-turris-nor .config
[ -n "$USE_CCACHE" ] && echo "CONFIG_CCACHE=y" >> .config
make defconfig
make clean
make "$@"
[ -d ./bin/mpc85xx/packages ] && rm -rf ./bin/mpc85xx/packages
[ -d ./bin-nor ] && rm -rf ./bin-nor
mv ./bin ./bin-nor


