From e3aede8127d0ecc160a2f421af00f762af78b083 Mon Sep 17 00:00:00 2001
Message-ID: <e3aede8127d0ecc160a2f421af00f762af78b083.1757512252.git.lorenzo@kernel.org>
In-Reply-To: <e134420e2a93d0febe112f1459b27b26a87017c4.1757512252.git.lorenzo@kernel.org>
References: <e134420e2a93d0febe112f1459b27b26a87017c4.1757512252.git.lorenzo@kernel.org>
From: Lorenzo Bianconi <lorenzo@kernel.org>
Date: Fri, 25 Jul 2025 12:38:26 +0200
Subject: [PATCH 3/5] wifi: mt76: Add the capability to set TX token start ID

This is a preliminary patch to enable traffic forward offloading via the
Airoha NPU module available on the Airoha EN7581 SoC.

Signed-off-by: Lorenzo Bianconi <lorenzo@kernel.org>
---
 mt76.h | 1 +
 tx.c   | 6 ++++--
 2 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/mt76.h b/mt76.h
index 9788fbb1..2534587c 100644
--- a/mt76.h
+++ b/mt76.h
@@ -949,6 +949,7 @@ struct mt76_dev {
 	struct idr token;
 	u16 wed_token_count;
 	u16 token_count;
+	u16 token_start;
 	u16 token_size;
 
 	spinlock_t rx_token_lock;
diff --git a/tx.c b/tx.c
index 8ab5840f..27d9122a 100644
--- a/tx.c
+++ b/tx.c
@@ -846,8 +846,10 @@ int mt76_token_consume(struct mt76_dev *dev, struct mt76_txwi_cache **ptxwi)
 
 	spin_lock_bh(&dev->token_lock);
 
-	token = idr_alloc(&dev->token, *ptxwi, 0, dev->token_size, GFP_ATOMIC);
-	if (token >= 0)
+	token = idr_alloc(&dev->token, *ptxwi, dev->token_start,
+			  dev->token_start + dev->token_size,
+			  GFP_ATOMIC);
+	if (token >= dev->token_start)
 		dev->token_count++;
 
 #ifdef CONFIG_NET_MEDIATEK_SOC_WED
-- 
2.51.0

